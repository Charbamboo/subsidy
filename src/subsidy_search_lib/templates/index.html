<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è£œåŠ©é‡‘æ¤œç´¢ | Jã‚°ãƒ©ãƒ³ãƒ„ API</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="background-pattern"></div>
    
    <header class="header">
        <div class="header-content">
            <h1 class="logo">
                <span class="logo-icon">ğŸ“‹</span>
                <span class="logo-text">è£œåŠ©é‡‘æ¤œç´¢</span>
            </h1>
            <p class="subtitle">Jã‚°ãƒ©ãƒ³ãƒ„å…¬é–‹APIã‚’ä½¿ç”¨ã—ãŸè£œåŠ©é‡‘æƒ…å ±æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ </p>
        </div>
    </header>

    <main class="main-container">
        <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
        <section class="search-section">
            <div class="search-card">
                <h2 class="section-title">
                    <span class="title-icon">ğŸ”</span>
                    æ¤œç´¢æ¡ä»¶
                </h2>
                
                <form id="search-form" class="search-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="keyword" class="form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                            <input 
                                type="text" 
                                id="keyword" 
                                name="keyword" 
                                class="form-input"
                                placeholder="è£œåŠ©é‡‘åã€è©³ç´°ã§æ¤œç´¢..."
                            >
                        </div>

                        <div class="form-group">
                            <label for="target_area" class="form-label">å¯¾è±¡åœ°åŸŸ</label>
                            <select id="target_area" name="target_area" class="form-select">
                                <option value="">ã™ã¹ã¦ã®åœ°åŸŸ</option>
                                {% for area in target_areas %}
                                <option value="{{ area }}">{{ area }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="subsidy_max_limit" class="form-label">è£œåŠ©é‡‘ä¸Šé™é¡ï¼ˆå††ï¼‰</label>
                            <input 
                                type="number" 
                                id="subsidy_max_limit" 
                                name="subsidy_max_limit" 
                                class="form-input"
                                placeholder="ä¾‹: 1000000"
                                min="0"
                            >
                        </div>

                        <div class="form-group">
                            <label for="target_number_of_employees" class="form-label">å¯¾è±¡å¾“æ¥­å“¡æ•°</label>
                            <select id="target_number_of_employees" name="target_number_of_employees" class="form-select">
                                <option value="">ã™ã¹ã¦</option>
                                {% for count in employee_counts %}
                                <option value="{{ count }}">{{ count }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="use_purpose" class="form-label">åˆ©ç”¨ç›®çš„</label>
                            <select id="use_purpose" name="use_purpose" class="form-select">
                                <option value="">ã™ã¹ã¦</option>
                                {% for purpose in use_purposes %}
                                <option value="{{ purpose }}">{{ purpose }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="acceptance_only" name="acceptance_only" class="form-checkbox">
                                <span class="checkbox-text">å—ä»˜ä¸­ã®è£œåŠ©é‡‘ã®ã¿è¡¨ç¤º</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-icon">ğŸ”</span>
                            æ¤œç´¢ã™ã‚‹
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <span class="btn-icon">â†º</span>
                            ãƒªã‚»ãƒƒãƒˆ
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- æ¤œç´¢çµæœ -->
        <section class="results-section">
            <div class="results-header">
                <h2 class="section-title">
                    <span class="title-icon">ğŸ“Š</span>
                    æ¤œç´¢çµæœ
                </h2>
                <div id="result-count" class="result-count"></div>
            </div>

            <div id="loading" class="loading hidden">
                <div class="loading-spinner"></div>
                <p>æ¤œç´¢ä¸­...</p>
            </div>

            <div id="error-message" class="error-message hidden"></div>

            <div id="results-container" class="results-grid"></div>
        </section>
    </main>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detail-modal" class="modal hidden">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <button class="modal-close" aria-label="é–‰ã˜ã‚‹">&times;</button>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <footer class="footer">
        <p>ãƒ‡ãƒ¼ã‚¿å‡ºå…¸: <a href="https://developers.digital.go.jp/documents/jgrants/api/" target="_blank" rel="noopener">ãƒ‡ã‚¸ã‚¿ãƒ«åº Jã‚°ãƒ©ãƒ³ãƒ„ API</a></p>
    </footer>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const searchForm = document.getElementById('search-form');
        const resultsContainer = document.getElementById('results-container');
        const resultCount = document.getElementById('result-count');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('error-message');
        const detailModal = document.getElementById('detail-modal');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.querySelector('.modal-close');
        const modalOverlay = document.querySelector('.modal-overlay');

        // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // UIã®åˆæœŸåŒ–
            loading.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            resultsContainer.innerHTML = '';
            resultCount.textContent = '';

            const formData = new FormData(searchForm);

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data.subsidies, data.count);
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                loading.classList.add('hidden');
            }
        });

        // æ¤œç´¢çµæœã®è¡¨ç¤º
        function displayResults(subsidies, count) {
            resultCount.textContent = `${count}ä»¶ã®è£œåŠ©é‡‘ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

            if (subsidies.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <span class="no-results-icon">ğŸ”</span>
                        <p>æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è£œåŠ©é‡‘ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                        <p class="no-results-hint">æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
                    </div>
                `;
                return;
            }

            resultsContainer.innerHTML = subsidies.map((subsidy, index) => `
                <div class="result-card" style="animation-delay: ${index * 0.05}s">
                    <div class="card-header">
                        <span class="subsidy-id">${subsidy.name || '-'}</span>
                        <span class="subsidy-amount">${subsidy.subsidy_max_limit}</span>
                    </div>
                    <h3 class="card-title">${subsidy.title || 'åç§°æœªè¨­å®š'}</h3>
                    <div class="card-meta">
                        <div class="meta-item">
                            <span class="meta-icon">ğŸ“</span>
                            <span>${subsidy.target_area || 'å…¨å›½'}</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">ğŸ‘¥</span>
                            <span>${subsidy.target_employees || 'åˆ¶é™ãªã—'}</span>
                        </div>
                    </div>
                    <div class="card-dates">
                        <span class="date-label">å—ä»˜æœŸé–“:</span>
                        <span>${formatDate(subsidy.acceptance_start)} ï½ ${formatDate(subsidy.acceptance_end)}</span>
                    </div>
                    <button class="btn btn-detail" onclick="showDetail('${subsidy.id}')">
                        è©³ç´°ã‚’è¦‹ã‚‹
                    </button>
                </div>
            `).join('');
        }

        // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            } catch {
                return dateStr;
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
        async function showDetail(subsidyId) {
            modalBody.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>èª­ã¿è¾¼ã¿ä¸­...</p></div>';
            detailModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            try {
                const response = await fetch(`/detail/${subsidyId}`);
                const data = await response.json();

                if (data.success) {
                    displayDetail(data.subsidy);
                } else {
                    modalBody.innerHTML = `<div class="error-message">${data.error}</div>`;
                }
            } catch (error) {
                modalBody.innerHTML = '<div class="error-message">è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
            }
        }

        // è©³ç´°æƒ…å ±ã®è¡¨ç¤º
        function displayDetail(subsidy) {
            modalBody.innerHTML = `
                <div class="detail-header">
                    <span class="detail-id">${subsidy.name || '-'}</span>
                    <h2 class="detail-title">${subsidy.title || 'åç§°æœªè¨­å®š'}</h2>
                    ${subsidy.catch_phrase ? `<p class="detail-catchphrase">${subsidy.catch_phrase}</p>` : ''}
                </div>

                <div class="detail-section">
                    <h3 class="detail-section-title">æ¦‚è¦</h3>
                    <p class="detail-text">${subsidy.detail || 'è©³ç´°æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'}</p>
                </div>

                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">è£œåŠ©é‡‘ä¸Šé™</span>
                        <span class="detail-value highlight">${subsidy.subsidy_max_limit}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">è£œåŠ©ç‡</span>
                        <span class="detail-value">${subsidy.subsidy_rate || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å¯¾è±¡åœ°åŸŸ</span>
                        <span class="detail-value">${subsidy.target_area || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">åœ°åŸŸè©³ç´°</span>
                        <span class="detail-value">${subsidy.target_area_detail || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å¯¾è±¡å¾“æ¥­å“¡æ•°</span>
                        <span class="detail-value">${subsidy.target_employees || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å¯¾è±¡æ¥­ç¨®</span>
                        <span class="detail-value">${subsidy.industry || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">åˆ©ç”¨ç›®çš„</span>
                        <span class="detail-value">${subsidy.use_purpose || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å—ä»˜é–‹å§‹</span>
                        <span class="detail-value">${formatDate(subsidy.acceptance_start)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å—ä»˜çµ‚äº†</span>
                        <span class="detail-value">${formatDate(subsidy.acceptance_end)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">äº‹æ¥­çµ‚äº†æœŸé™</span>
                        <span class="detail-value">${formatDate(subsidy.project_end_deadline)}</span>
                    </div>
                </div>

                ${subsidy.detail_url ? `
                    <div class="detail-actions">
                        <a href="${subsidy.detail_url}" target="_blank" rel="noopener" class="btn btn-primary">
                            <span class="btn-icon">ğŸ”—</span>
                            Jã‚°ãƒ©ãƒ³ãƒ„ã§è©³ç´°ã‚’è¦‹ã‚‹
                        </a>
                    </div>
                ` : ''}
            `;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            detailModal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        modalClose.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', closeModal);

        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !detailModal.classList.contains('hidden')) {
                closeModal();
            }
        });
    </script>
</body>
</html>

